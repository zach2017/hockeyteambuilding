<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORAL TEAM Hockey - Online Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
        }
        #gameCanvas {
            display: block;
            background: radial-gradient(ellipse at center, #f0f9ff 0%, #bae6fd 50%, #7dd3fc 100%);
        }
        .glow-text {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                         0 0 20px rgba(6, 182, 212, 0.6),
                         0 0 30px rgba(6, 182, 212, 0.4);
        }
        .coral-gradient {
            background: linear-gradient(135deg, #ff6b9d 0%, #ffa06b 50%, #ff6b9d 100%);
        }
        .neon-border {
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5),
                        0 0 30px rgba(6, 182, 212, 0.3),
                        inset 0 0 15px rgba(6, 182, 212, 0.2);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(6, 182, 212, 0.5); }
            50% { box-shadow: 0 0 40px rgba(6, 182, 212, 0.8); }
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        .copy-btn {
            transition: all 0.2s;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-cyan-900 to-gray-900">
    <!-- Header -->
    <div class="fixed top-0 left-0 right-0 coral-gradient text-white p-6 shadow-2xl z-10 neon-border">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="text-center flex-1">
                    <h2 class="text-3xl font-black text-cyan-100 glow-text">üåä CORAL TEAM</h2>
                    <p class="text-5xl font-black mt-2 glow-text" id="coralScore">0</p>
                    <p class="text-xs mt-1 text-cyan-200" id="coralPlayerCount">0 players</p>
                </div>
                <div class="text-center px-8">
                    <h1 class="text-3xl font-black glow-text">üèí CORAL TEAM HOCKEY ‚ö°</h1>
                    <p class="text-sm mt-1 text-cyan-100">Online Multiplayer Arena</p>
                    <div id="connectionStatus" class="mt-2 text-xs"></div>
                </div>
                <div class="text-center flex-1">
                    <h2 class="text-3xl font-black text-purple-100 glow-text">‚ö° STORM TEAM</h2>
                    <p class="text-5xl font-black mt-2 glow-text" id="stormScore">0</p>
                    <p class="text-xs mt-1 text-purple-200" id="stormPlayerCount">0 players</p>
                </div>
            </div>
            
            <div class="flex justify-center items-center gap-4" id="menuControls">
                <button id="hostGameBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 px-10 py-4 rounded-xl font-black text-2xl shadow-lg pulse-glow transform hover:scale-105 transition">
                    üéÆ HOST GAME
                </button>
                <button id="joinGameBtn" class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 px-10 py-4 rounded-xl font-black text-2xl shadow-lg pulse-glow transform hover:scale-105 transition">
                    üîó JOIN GAME
                </button>
            </div>
            
            <div class="text-center mt-2 hidden" id="gameStatus">
                <p class="text-xl font-bold glow-text" id="statusText">Waiting for players...</p>
            </div>
        </div>
    </div>

    <!-- Host Game Modal -->
    <div id="hostModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-gradient-to-br from-gray-900 via-green-900 to-gray-900 p-8 rounded-3xl shadow-2xl max-w-2xl w-full mx-4 neon-border border-4 border-green-400">
            <h2 class="text-4xl font-black text-center mb-6 glow-text">üéÆ HOST NEW GAME</h2>
            
            <div class="bg-black bg-opacity-40 p-6 rounded-xl mb-6">
                <label class="block text-white font-bold mb-3">Your Name:</label>
                <input type="text" id="hostName" placeholder="Enter your name" maxlength="15"
                       class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border-2 border-green-400 focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-bold">
            </div>

            <div class="bg-black bg-opacity-40 p-6 rounded-xl mb-6">
                <label class="block text-white font-bold mb-3">Select Your Team:</label>
                <div class="grid grid-cols-2 gap-4">
                    <button id="hostCoralBtn" class="team-select bg-cyan-600 hover:bg-cyan-500 px-6 py-4 rounded-lg font-bold text-white transition border-4 border-transparent">
                        üåä CORAL TEAM
                    </button>
                    <button id="hostStormBtn" class="team-select bg-purple-600 hover:bg-purple-500 px-6 py-4 rounded-lg font-bold text-white transition border-4 border-transparent">
                        ‚ö° STORM TEAM
                    </button>
                </div>
            </div>

            <div id="gameKeyDisplay" class="hidden bg-gradient-to-r from-yellow-800 to-orange-800 p-6 rounded-xl mb-6 border-4 border-yellow-400">
                <h3 class="text-2xl font-black text-yellow-100 mb-3 text-center">üîë GAME KEY</h3>
                <div class="flex items-center gap-3">
                    <input type="text" id="gameKey" readonly
                           class="flex-1 px-4 py-4 rounded-lg bg-black text-white font-black text-2xl text-center border-2 border-yellow-400">
                    <button id="copyKeyBtn" class="copy-btn bg-yellow-500 hover:bg-yellow-400 px-6 py-4 rounded-lg font-black">
                        üìã COPY
                    </button>
                </div>
                <p class="text-center text-yellow-100 mt-3 font-bold">Share this key with other players!</p>
                <p class="text-center text-yellow-200 mt-2 text-sm">Waiting for players to join...</p>
                <div id="connectedPlayers" class="mt-4 space-y-2"></div>
            </div>

            <div class="flex gap-4">
                <button id="startHostedGameBtn" class="flex-1 bg-green-500 hover:bg-green-400 px-8 py-4 rounded-xl font-black text-2xl shadow-lg transform hover:scale-105 transition hidden">
                    üèí START GAME
                </button>
                <button id="cancelHostBtn" class="flex-1 bg-red-500 hover:bg-red-400 px-8 py-4 rounded-xl font-black text-2xl shadow-lg transform hover:scale-105 transition">
                    ‚ùå CANCEL
                </button>
            </div>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div id="joinModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 p-8 rounded-3xl shadow-2xl max-w-2xl w-full mx-4 neon-border border-4 border-blue-400">
            <h2 class="text-4xl font-black text-center mb-6 glow-text">üîó JOIN GAME</h2>
            
            <div class="bg-black bg-opacity-40 p-6 rounded-xl mb-6">
                <label class="block text-white font-bold mb-3">Your Name:</label>
                <input type="text" id="joinName" placeholder="Enter your name" maxlength="15"
                       class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border-2 border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold">
            </div>

            <div class="bg-black bg-opacity-40 p-6 rounded-xl mb-6">
                <label class="block text-white font-bold mb-3">Game Key:</label>
                <input type="text" id="joinKey" placeholder="Enter game key" maxlength="50"
                       class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border-2 border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold">
            </div>

            <div class="bg-black bg-opacity-40 p-6 rounded-xl mb-6">
                <label class="block text-white font-bold mb-3">Select Your Team:</label>
                <div class="grid grid-cols-2 gap-4">
                    <button id="joinCoralBtn" class="team-select bg-cyan-600 hover:bg-cyan-500 px-6 py-4 rounded-lg font-bold text-white transition border-4 border-transparent">
                        üåä CORAL TEAM
                    </button>
                    <button id="joinStormBtn" class="team-select bg-purple-600 hover:bg-purple-500 px-6 py-4 rounded-lg font-bold text-white transition border-4 border-transparent">
                        ‚ö° STORM TEAM
                    </button>
                </div>
            </div>

            <div id="joinStatus" class="text-center text-yellow-100 mb-4 font-bold hidden"></div>

            <div class="flex gap-4">
                <button id="connectBtn" class="flex-1 bg-blue-500 hover:bg-blue-400 px-8 py-4 rounded-xl font-black text-2xl shadow-lg transform hover:scale-105 transition">
                    üîó CONNECT
                </button>
                <button id="cancelJoinBtn" class="flex-1 bg-red-500 hover:bg-red-400 px-8 py-4 rounded-xl font-black text-2xl shadow-lg transform hover:scale-105 transition">
                    ‚ùå CANCEL
                </button>
            </div>
        </div>
    </div>

    <!-- Active Players Panel -->
    <div class="fixed bottom-4 right-4 bg-gradient-to-br from-gray-900 to-purple-900 text-white p-6 rounded-2xl shadow-2xl z-10 neon-border border-2 border-purple-400 max-h-[60vh] overflow-y-auto">
        <h3 class="font-black text-xl mb-3 glow-text">üë• PLAYERS</h3>
        <div class="space-y-2 text-sm" id="activePlayers"></div>
    </div>

    <!-- Controls Info -->
    <div class="fixed bottom-4 left-4 bg-gradient-to-br from-gray-900 to-cyan-900 text-white p-6 rounded-2xl shadow-2xl z-10 neon-border border-2 border-cyan-400">
        <h3 class="font-black text-xl mb-3 glow-text">‚ö° CONTROLS</h3>
        <div class="space-y-2 text-xs">
            <p><strong class="text-cyan-300">Move:</strong> <span class="text-cyan-100">WASD or Arrow Keys</span></p>
            <p class="mt-3 pt-3 border-t border-cyan-700"><strong class="text-yellow-300">üèÜ:</strong> Score goals!</p>
            <p class="text-gray-400 mt-2">Your player will glow!</p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // ==================== NETWORK SETUP ====================
        let peer = null;
        let connections = [];
        let isHost = false;
        let myPlayerId = null;
        let myTeam = null;
        let myName = '';
        let gameState = null;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ==================== MODAL CONTROLS ====================
        const hostGameBtn = document.getElementById('hostGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const hostModal = document.getElementById('hostModal');
        const joinModal = document.getElementById('joinModal');
        const cancelHostBtn = document.getElementById('cancelHostBtn');
        const cancelJoinBtn = document.getElementById('cancelJoinBtn');
        const gameKeyDisplay = document.getElementById('gameKeyDisplay');
        const copyKeyBtn = document.getElementById('copyKeyBtn');
        const startHostedGameBtn = document.getElementById('startHostedGameBtn');
        const connectBtn = document.getElementById('connectBtn');

        let selectedHostTeam = null;
        let selectedJoinTeam = null;

        hostGameBtn.addEventListener('click', () => {
            hostModal.classList.remove('hidden');
        });

        joinGameBtn.addEventListener('click', () => {
            joinModal.classList.remove('hidden');
        });

        cancelHostBtn.addEventListener('click', () => {
            hostModal.classList.add('hidden');
            if (peer) peer.destroy();
            connections = [];
        });

        cancelJoinBtn.addEventListener('click', () => {
            joinModal.classList.add('hidden');
            if (peer) peer.destroy();
        });

        // Team selection for host
        document.getElementById('hostCoralBtn').addEventListener('click', function() {
            document.querySelectorAll('#hostModal .team-select').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'ring-4', 'ring-yellow-400');
            });
            this.classList.add('border-yellow-400', 'ring-4', 'ring-yellow-400');
            selectedHostTeam = 'coral';
        });

        document.getElementById('hostStormBtn').addEventListener('click', function() {
            document.querySelectorAll('#hostModal .team-select').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'ring-4', 'ring-yellow-400');
            });
            this.classList.add('border-yellow-400', 'ring-4', 'ring-yellow-400');
            selectedHostTeam = 'storm';
        });

        // Team selection for join
        document.getElementById('joinCoralBtn').addEventListener('click', function() {
            document.querySelectorAll('#joinModal .team-select').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'ring-4', 'ring-yellow-400');
            });
            this.classList.add('border-yellow-400', 'ring-4', 'ring-yellow-400');
            selectedJoinTeam = 'coral';
        });

        document.getElementById('joinStormBtn').addEventListener('click', function() {
            document.querySelectorAll('#joinModal .team-select').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'ring-4', 'ring-yellow-400');
            });
            this.classList.add('border-yellow-400', 'ring-4', 'ring-yellow-400');
            selectedJoinTeam = 'storm';
        });

        // ==================== HOST GAME ====================
        document.getElementById('hostName').addEventListener('input', function() {
            if (this.value.trim() && selectedHostTeam) {
                document.getElementById('hostCoralBtn').disabled = false;
                document.getElementById('hostStormBtn').disabled = false;
                checkHostReadyToCreate();
            }
        });

        function checkHostReadyToCreate() {
            const name = document.getElementById('hostName').value.trim();
            if (name && selectedHostTeam) {
                createHostGame();
            }
        }

        document.getElementById('hostCoralBtn').addEventListener('click', checkHostReadyToCreate);
        document.getElementById('hostStormBtn').addEventListener('click', checkHostReadyToCreate);

        function createHostGame() {
            const name = document.getElementById('hostName').value.trim();
            if (!name || !selectedHostTeam) return;

            myName = name;
            myTeam = selectedHostTeam;
            isHost = true;

            // Generate unique game ID
            const gameId = 'coral-hockey-' + Math.random().toString(36).substr(2, 9);
            
            peer = new Peer(gameId);

            peer.on('open', (id) => {
                myPlayerId = id;
                document.getElementById('gameKey').value = id;
                gameKeyDisplay.classList.remove('hidden');
                startHostedGameBtn.classList.remove('hidden');
                
                updateConnectionStatus('Waiting for players...', 'text-yellow-300');

                // Initialize game state
                gameState = {
                    players: {},
                    puck: {
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        vx: 0,
                        vy: 0
                    },
                    scores: { coral: 0, storm: 0 }
                };

                // Add host player
                gameState.players[myPlayerId] = {
                    id: myPlayerId,
                    name: myName,
                    team: myTeam,
                    x: canvas.width / 4,
                    y: canvas.height / 2,
                    keys: { w: false, a: false, s: false, d: false }
                };

                updateConnectedPlayersList();
            });

            peer.on('connection', (conn) => {
                connections.push(conn);

                conn.on('open', () => {
                    console.log('New player connected:', conn.peer);
                });

                conn.on('data', (data) => {
                    handleIncomingData(data, conn);
                });

                conn.on('close', () => {
                    connections = connections.filter(c => c !== conn);
                    if (gameState && gameState.players[conn.peer]) {
                        delete gameState.players[conn.peer];
                        updateConnectedPlayersList();
                        broadcastGameState();
                    }
                });
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateConnectionStatus('Error: ' + err.type, 'text-red-400');
            });
        }

        copyKeyBtn.addEventListener('click', () => {
            const keyInput = document.getElementById('gameKey');
            keyInput.select();
            document.execCommand('copy');
            
            copyKeyBtn.textContent = '‚úÖ COPIED!';
            setTimeout(() => {
                copyKeyBtn.textContent = 'üìã COPY';
            }, 2000);
        });

        startHostedGameBtn.addEventListener('click', () => {
            if (Object.keys(gameState.players).length < 2) {
                alert('Wait for at least one other player to join!');
                return;
            }

            hostModal.classList.add('hidden');
            startGame();
            
            // Tell all clients to start
            broadcast({ type: 'start_game' });
        });

        function updateConnectedPlayersList() {
            const list = document.getElementById('connectedPlayers');
            list.innerHTML = '';

            Object.values(gameState.players).forEach(player => {
                const div = document.createElement('div');
                div.className = `p-2 rounded ${player.team === 'coral' ? 'bg-cyan-700' : 'bg-purple-700'}`;
                div.textContent = `${player.team === 'coral' ? 'üåä' : '‚ö°'} ${player.name}`;
                list.appendChild(div);
            });

            updatePlayerCounts();
        }

        // ==================== JOIN GAME ====================
        connectBtn.addEventListener('click', () => {
            const name = document.getElementById('joinName').value.trim();
            const gameKey = document.getElementById('joinKey').value.trim();

            if (!name) {
                alert('Please enter your name!');
                return;
            }

            if (!gameKey) {
                alert('Please enter a game key!');
                return;
            }

            if (!selectedJoinTeam) {
                alert('Please select a team!');
                return;
            }

            myName = name;
            myTeam = selectedJoinTeam;
            isHost = false;

            joinGame(gameKey);
        });

        function joinGame(hostId) {
            peer = new Peer();

            peer.on('open', (id) => {
                myPlayerId = id;
                
                const conn = peer.connect(hostId);
                connections.push(conn);

                conn.on('open', () => {
                    updateJoinStatus('Connected! Waiting for game to start...', 'text-green-400');
                    
                    // Send join request
                    conn.send({
                        type: 'join',
                        playerId: myPlayerId,
                        name: myName,
                        team: myTeam
                    });
                });

                conn.on('data', (data) => {
                    handleIncomingData(data, conn);
                });

                conn.on('close', () => {
                    updateJoinStatus('Disconnected from host', 'text-red-400');
                });

                conn.on('error', (err) => {
                    updateJoinStatus('Connection error: ' + err, 'text-red-400');
                });
            });

            peer.on('error', (err) => {
                updateJoinStatus('Error: ' + err.type, 'text-red-400');
            });
        }

        function updateJoinStatus(message, colorClass) {
            const status = document.getElementById('joinStatus');
            status.textContent = message;
            status.className = `text-center mb-4 font-bold ${colorClass}`;
            status.classList.remove('hidden');
        }

        // ==================== NETWORK COMMUNICATION ====================
        function handleIncomingData(data, conn) {
            if (data.type === 'join' && isHost) {
                // New player joining
                const startX = data.team === 'coral' ? canvas.width / 4 : canvas.width * 0.75;
                const startY = canvas.height / 2;

                gameState.players[data.playerId] = {
                    id: data.playerId,
                    name: data.name,
                    team: data.team,
                    x: startX,
                    y: startY,
                    keys: { w: false, a: false, s: false, d: false }
                };

                updateConnectedPlayersList();
                
                // Send current game state to new player
                conn.send({
                    type: 'game_state',
                    state: gameState
                });

                // Broadcast to all other players
                broadcastGameState();
            }
            else if (data.type === 'game_state' && !isHost) {
                // Receiving initial game state as client
                gameState = data.state;
                updatePlayerCounts();
                updateActivePlayersList();
            }
            else if (data.type === 'state_update') {
                // Regular game state update
                if (gameState) {
                    // Update other players
                    Object.keys(data.players).forEach(playerId => {
                        if (playerId !== myPlayerId && gameState.players[playerId]) {
                            gameState.players[playerId].x = data.players[playerId].x;
                            gameState.players[playerId].y = data.players[playerId].y;
                            gameState.players[playerId].keys = data.players[playerId].keys;
                        }
                    });

                    // Update puck
                    gameState.puck = data.puck;
                    
                    // Update scores
                    gameState.scores = data.scores;
                    document.getElementById('coralScore').textContent = gameState.scores.coral;
                    document.getElementById('stormScore').textContent = gameState.scores.storm;
                }
            }
            else if (data.type === 'player_input' && isHost) {
                // Update player keys from client
                if (gameState.players[data.playerId]) {
                    gameState.players[data.playerId].keys = data.keys;
                }
            }
            else if (data.type === 'start_game' && !isHost) {
                joinModal.classList.add('hidden');
                startGame();
            }
        }

        function broadcast(data) {
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }

        function broadcastGameState() {
            if (!isHost || !gameState) return;

            const stateUpdate = {
                type: 'state_update',
                players: {},
                puck: gameState.puck,
                scores: gameState.scores
            };

            // Send all player positions
            Object.keys(gameState.players).forEach(playerId => {
                stateUpdate.players[playerId] = {
                    x: gameState.players[playerId].x,
                    y: gameState.players[playerId].y,
                    keys: gameState.players[playerId].keys
                };
            });

            broadcast(stateUpdate);
        }

        function sendPlayerInput() {
            if (isHost || !gameState || !gameState.players[myPlayerId]) return;

            const myPlayer = gameState.players[myPlayerId];
            connections[0]?.send({
                type: 'player_input',
                playerId: myPlayerId,
                keys: myPlayer.keys
            });
        }

        function updateConnectionStatus(message, colorClass) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = colorClass;
        }

        // ==================== GAME STATE ====================
        let gameStarted = false;
        let particles = [];

        const puck = {
            radius: 15,
            friction: 0.98,
            color: '#1a1a1a',
            trail: []
        };

        const goalWidth = 25;
        const goalHeight = 160;
        const leftGoal = { x: 0, y: 0, width: goalWidth, height: goalHeight };
        const rightGoal = { x: 0, y: 0, width: goalWidth, height: goalHeight };

        const playerColors = {
            coral: [
                { main: '#06b6d4', accent: '#ff6b9d' },
                { main: '#0ea5e9', accent: '#f472b6' },
                { main: '#14b8a6', accent: '#fb7185' },
                { main: '#22d3ee', accent: '#fda4af' }
            ],
            storm: [
                { main: '#a855f7', accent: '#fbbf24' },
                { main: '#9333ea', accent: '#fcd34d' },
                { main: '#c084fc', accent: '#facc15' },
                { main: '#d946ef', accent: '#fde047' }
            ]
        };

        function startGame() {
            gameStarted = true;
            document.getElementById('menuControls').classList.add('hidden');
            document.getElementById('gameStatus').classList.remove('hidden');
            document.getElementById('statusText').textContent = 'GAME ON! üèí';

            updateActivePlayersList();
            updateConnectionStatus(isHost ? 'üéÆ Hosting' : 'üîó Connected', 'text-green-400');
        }

        function updatePlayerCounts() {
            if (!gameState) return;
            
            const coralCount = Object.values(gameState.players).filter(p => p.team === 'coral').length;
            const stormCount = Object.values(gameState.players).filter(p => p.team === 'storm').length;
            
            document.getElementById('coralPlayerCount').textContent = `${coralCount} player${coralCount !== 1 ? 's' : ''}`;
            document.getElementById('stormPlayerCount').textContent = `${stormCount} player${stormCount !== 1 ? 's' : ''}`;
        }

        function updateActivePlayersList() {
            if (!gameState) return;

            const list = document.getElementById('activePlayers');
            list.innerHTML = '';

            Object.values(gameState.players).forEach(player => {
                const div = document.createElement('div');
                div.className = player.team === 'coral' ? 'text-cyan-300' : 'text-purple-300';
                const isMe = player.id === myPlayerId;
                div.textContent = `${player.team === 'coral' ? 'üåä' : '‚ö°'} ${player.name}${isMe ? ' (YOU)' : ''}`;
                if (isMe) div.classList.add('font-black', 'text-yellow-300');
                list.appendChild(div);
            });
        }

        // ==================== INPUT HANDLING ====================
        const pressedKeys = {};

        document.addEventListener('keydown', (e) => {
            if (!gameStarted || !gameState || !gameState.players[myPlayerId]) return;

            pressedKeys[e.key] = true;
            
            const myPlayer = gameState.players[myPlayerId];
            
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') myPlayer.keys.w = true;
            if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') myPlayer.keys.a = true;
            if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') myPlayer.keys.s = true;
            if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') myPlayer.keys.d = true;

            if (!isHost) {
                sendPlayerInput();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!gameStarted || !gameState || !gameState.players[myPlayerId]) return;

            pressedKeys[e.key] = false;
            
            const myPlayer = gameState.players[myPlayerId];
            
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') myPlayer.keys.w = false;
            if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') myPlayer.keys.a = false;
            if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') myPlayer.keys.s = false;
            if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') myPlayer.keys.d = false;

            if (!isHost) {
                sendPlayerInput();
            }
        });

        // ==================== PARTICLE SYSTEM ====================
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1;
                this.decay = 0.02;
                this.size = Math.random() * 5 + 2;
                this.color = color;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                this.vx *= 0.98;
                this.vy *= 0.98;
            }

            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // ==================== GAME LOGIC ====================
        function updatePlayer(player) {
            const speed = 5.5;
            
            if (player.keys.w) player.y -= speed;
            if (player.keys.s) player.y += speed;
            if (player.keys.a) player.x -= speed;
            if (player.keys.d) player.x += speed;

            const headerOffset = 180;
            player.x = Math.max(28, Math.min(canvas.width - 28, player.x));
            player.y = Math.max(headerOffset + 28, Math.min(canvas.height - 28, player.y));
        }

        function checkCollision(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < 28 + puck.radius;
        }

        function handlePlayerPuckCollision(player) {
            if (checkCollision(player, gameState.puck)) {
                const dx = gameState.puck.x - player.x;
                const dy = gameState.puck.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    const normalX = dx / distance;
                    const normalY = dy / distance;
                    
                    const overlap = 28 + puck.radius - distance;
                    gameState.puck.x += normalX * overlap;
                    gameState.puck.y += normalY * overlap;
                    
                    const force = 10;
                    gameState.puck.vx = normalX * force;
                    gameState.puck.vy = normalY * force;

                    for (let i = 0; i < 8; i++) {
                        const colors = playerColors[player.team];
                        particles.push(new Particle(gameState.puck.x, gameState.puck.y, colors[0].main));
                    }
                }
            }
        }

        function updatePuck() {
            gameState.puck.x += gameState.puck.vx;
            gameState.puck.y += gameState.puck.vy;
            
            gameState.puck.vx *= puck.friction;
            gameState.puck.vy *= puck.friction;
            
            if (Math.abs(gameState.puck.vx) < 0.1) gameState.puck.vx = 0;
            if (Math.abs(gameState.puck.vy) < 0.1) gameState.puck.vy = 0;
            
            const headerOffset = 180;
            if (gameState.puck.y - puck.radius < headerOffset || gameState.puck.y + puck.radius > canvas.height) {
                gameState.puck.vy *= -0.8;
                gameState.puck.y = gameState.puck.y - puck.radius < headerOffset ? headerOffset + puck.radius : canvas.height - puck.radius;
            }
            
            // Check goals
            if (gameState.puck.x - puck.radius < goalWidth) {
                if (gameState.puck.y > leftGoal.y && gameState.puck.y < leftGoal.y + leftGoal.height) {
                    gameState.scores.storm++;
                    resetPuck();
                    celebrateGoal('storm');
                } else {
                    gameState.puck.vx *= -0.8;
                    gameState.puck.x = goalWidth + puck.radius;
                }
            }
            
            if (gameState.puck.x + puck.radius > canvas.width - goalWidth) {
                if (gameState.puck.y > rightGoal.y && gameState.puck.y < rightGoal.y + rightGoal.height) {
                    gameState.scores.coral++;
                    resetPuck();
                    celebrateGoal('coral');
                } else {
                    gameState.puck.vx *= -0.8;
                    gameState.puck.x = canvas.width - goalWidth - puck.radius;
                }
            }
        }

        function celebrateGoal(team) {
            for (let i = 0; i < 100; i++) {
                const color = team === 'coral' ? '#06b6d4' : '#a855f7';
                particles.push(new Particle(canvas.width / 2, canvas.height / 2, color));
            }
            document.getElementById('statusText').textContent = `‚ö° ${team.toUpperCase()} SCORES! ‚ö°`;
            setTimeout(() => {
                document.getElementById('statusText').textContent = 'GAME ON! üèí';
            }, 2500);

            document.getElementById('coralScore').textContent = gameState.scores.coral;
            document.getElementById('stormScore').textContent = gameState.scores.storm;
        }

        function resetPuck() {
            gameState.puck.x = canvas.width / 2;
            gameState.puck.y = canvas.height / 2;
            gameState.puck.vx = 0;
            gameState.puck.vy = 0;
        }

        // ==================== RENDERING ====================
        function drawRink() {
            const headerOffset = 180;
            
            leftGoal.y = (canvas.height - goalHeight) / 2;
            rightGoal.x = canvas.width - goalWidth;
            rightGoal.y = (canvas.height - goalHeight) / 2;
            
            const gradient = ctx.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width / 2);
            gradient.addColorStop(0, '#f0f9ff');
            gradient.addColorStop(0.5, '#e0f2fe');
            gradient.addColorStop(1, '#bae6fd');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, headerOffset, canvas.width, canvas.height - headerOffset);
            
            ctx.strokeStyle = '#0284c7';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.25, headerOffset);
            ctx.lineTo(canvas.width * 0.25, canvas.height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.75, headerOffset);
            ctx.lineTo(canvas.width * 0.75, canvas.height);
            ctx.stroke();
            
            ctx.strokeStyle = '#dc2626';
            ctx.lineWidth = 5;
            ctx.setLineDash([20, 15]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, headerOffset);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.strokeStyle = '#0284c7';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 100, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.fillStyle = '#dc2626';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 8, 0, Math.PI * 2);
            ctx.fill();
            
            drawGoal(leftGoal, '#06b6d4');
            drawGoal(rightGoal, '#a855f7');
        }

        function drawGoal(goal, color) {
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.3;
            ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
            ctx.globalAlpha = 1;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 6;
            ctx.strokeRect(goal.x, goal.y, goal.width, goal.height);
        }

        function drawPlayer(player) {
            const isMe = player.id === myPlayerId;
            const teamIndex = Object.values(gameState.players).filter(p => p.team === player.team).indexOf(player);
            const colors = playerColors[player.team][teamIndex % 4];

            if (isMe) {
                const pulseSize = 28 + Math.sin(Date.now() / 200) * 5;
                const glowGradient = ctx.createRadialGradient(player.x, player.y, pulseSize * 0.5, player.x, player.y, pulseSize * 3);
                glowGradient.addColorStop(0, '#ffff00cc');
                glowGradient.addColorStop(1, '#ffff0000');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(player.x, player.y, pulseSize * 3, 0, Math.PI * 2);
                ctx.fill();
            } else {
                const glowGradient = ctx.createRadialGradient(player.x, player.y, 14, player.x, player.y, 70);
                glowGradient.addColorStop(0, colors.main + '60');
                glowGradient.addColorStop(1, colors.main + '00');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 70, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
            ctx.beginPath();
            ctx.arc(player.x + 4, player.y + 4, 28, 0, Math.PI * 2);
            ctx.fill();
            
            const playerGradient = ctx.createRadialGradient(player.x - 5, player.y - 5, 0, player.x, player.y, 28);
            playerGradient.addColorStop(0, colors.accent);
            playerGradient.addColorStop(1, colors.main);
            ctx.fillStyle = playerGradient;
            ctx.beginPath();
            ctx.arc(player.x, player.y, 28, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = isMe ? '#ffff00' : 'white';
            ctx.lineWidth = isMe ? 5 : 4;
            ctx.stroke();

            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(player.x - 35, player.y - 48, 70, 18);
            ctx.fillStyle = isMe ? '#ffff00' : 'white';
            ctx.font = 'bold 11px Orbitron';
            ctx.textAlign = 'center';
            ctx.fillText(player.name.substring(0, 12), player.x, player.y - 35);
        }

        function drawPuck() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.beginPath();
            ctx.arc(gameState.puck.x + 3, gameState.puck.y + 3, puck.radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = puck.color;
            ctx.beginPath();
            ctx.arc(gameState.puck.x, gameState.puck.y, puck.radius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            particles.forEach(particle => particle.draw());
        }

        // ==================== GAME LOOP ====================
        let lastBroadcast = 0;
        const BROADCAST_INTERVAL = 50; // ms

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawRink();
            
            if (gameStarted && gameState) {
                // Host updates game logic
                if (isHost) {
                    Object.values(gameState.players).forEach(updatePlayer);
                    updatePuck();
                    Object.values(gameState.players).forEach(handlePlayerPuckCollision);
                    
                    // Broadcast state to clients
                    const now = Date.now();
                    if (now - lastBroadcast > BROADCAST_INTERVAL) {
                        broadcastGameState();
                        lastBroadcast = now;
                    }
                } else {
                    // Clients just update their own player
                    if (gameState.players[myPlayerId]) {
                        updatePlayer(gameState.players[myPlayerId]);
                    }
                }
                
                updateParticles();
            }
            
            if (gameState && gameState.players) {
                drawParticles();
                drawPuck();
                Object.values(gameState.players).forEach(drawPlayer);
            }
            
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>